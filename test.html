<!-- Test FIREBASE REALTIME DATABASE -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firebase Multi-Role Test</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      onValue, 
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  
  
    const firebaseConfig = {
      apiKey: "AIzaSyC4o7uIHSqRChe0k5LZOfnFDCr-vBWoqvY",
      authDomain: "speechster-1000.firebaseapp.com",
      databaseURL: "https://speechster-1000-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "speechster-1000",
      storageBucket: "speechster-1000.firebasestorage.app",
      messagingSenderId: "543492593404",
      appId: "1:543492593404:web:df0f06a3db1af716626979",
      measurementId: "G-RM7GFYFZB9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Test accounts
    const patientEmail = "patient2@example.com";
    const doctorEmail = "doctor1@example.com";
    const password = "test1234";

    // Utility: create or sign in a user
    async function ensureUser(email, password) {
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        console.log("âœ… User created:", email);
        return cred.user;
      } catch (err) {
        if (err.code === "auth/email-already-in-use") {
          const cred = await signInWithEmailAndPassword(auth, email, password);
          console.log("ğŸ”„ Signed in:", email);
          return cred.user;
        } else {
          throw err;
        }
      }
    }

    async function runTest() {
      // Patient test
      const patient = await ensureUser(patientEmail, password);
      await set(ref(db, `users/patients/${patient.uid}/profile`), {
        username: "Patient Test",
        email: patient.email,
        createdAt: serverTimestamp()
      });
      console.log("âœ… Patient profile written");

      // Add a session
      const sessionRef = ref(db, `users/patients/${patient.uid}/sessions/session1`);
      await set(sessionRef, {
        score: 42,
        timestamp: serverTimestamp()
      });
      console.log("âœ… Patient session written");

      // Read back
      onValue(ref(db, `users/patients/${patient.uid}`), snap => {
        console.log("ğŸ“¥ Patient data:", snap.val());
      });

      // Doctor test
      const doctor = await ensureUser(doctorEmail, password);
      await set(ref(db, `users/doctors/${doctor.uid}/profile`), {
        username: "Doctor Test",
        email: doctor.email,
        createdAt: serverTimestamp()
      });
      console.log("âœ… Doctor profile written");

      // Assign patient to doctor
      await set(ref(db, `users/doctors/${doctor.uid}/assignedPatients/${patient.uid}`), true);
      console.log("âœ… Doctor assigned patient");

      // Doctor tries to read patient data (âš ï¸ may fail unless your rules allow broader doctor access)
      onValue(ref(db, `users/patients/${patient.uid}`), snap => {
        console.log("ğŸ“¥ Doctor view of patient:", snap.val());
      });
    }

    runTest().catch(err => console.error("âŒ Test error:", err.message));

    onAuthStateChanged(auth, user => {
      if (user) console.log("ğŸ‘¤ Logged in as:", user.email);
      else console.log("ğŸšª Logged out");
    });
  </script>
</head>
<body>
  <h1>Check console for doctor/patient test results ğŸš€</h1>
</body>
</html>
